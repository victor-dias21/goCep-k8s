name: 0. CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  # Derive the commit SHA that downstream reusable workflows must check out.
  context:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      sha: ${{ steps.compute-sha.outputs.sha }}
    steps:
      - id: compute-sha
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
          else
            echo "sha=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

  # Reusable job: lint + tests + binary artifact.
  tests:
    needs: context
    permissions:
      contents: read
    uses: ./.github/workflows/1-test-lint.yaml
    with:
      source-sha: ${{ needs.context.outputs.sha }}

  # Reusable job: build Docker image and publish it as an artifact.
  build:
    needs: [context, tests]
    permissions:
      contents: read
      actions: read
    uses: ./.github/workflows/2-build-docker.yaml
    with:
      source-sha: ${{ needs.context.outputs.sha }}
    secrets: inherit

  # Reusable job: scan the produced image with Trivy.
  scan:
    needs: [context, build]
    permissions:
      contents: read
      security-events: write
    uses: ./.github/workflows/3-scan-security.yaml
    with:
      source-sha: ${{ needs.context.outputs.sha }}
    secrets: inherit

  # Reusable job: push the image to Docker Hub (requires secrets).
  push-registry:
    needs: [context, scan]
    permissions:
      contents: read
    uses: ./.github/workflows/4-push-registry.yaml
    with:
      source-sha: ${{ needs.context.outputs.sha }}
    secrets: inherit
